<!DOCTYPE html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="assets/highlight/codemirror.css" />
    <link rel="stylesheet" href="assets/style.css">
  </head>
  <body>
    <div id="left-side">
      <input id="create-input" type="text" placeholder="New file..." />
      <i id="add-icon" onclick="addIconClick()" class="material-icons">add</i>
      <div class="resize-handle"></div>
    </div>
    <div id="right-side">
      <div class="top_content">
        <h1 id="title"></h1>
        <div class="container__file_control_panel">
          <i id="save-icon" onclick="saveIconClick()" class="material-icons">save</i>
          <i id="del-icon" onclick="delIconClick()" class="material-icons">delete</i>
        </div>
      </div>
      <div id="editor"></div>
    </div>
    <script src="../node_modules/codemirror/lib/codemirror.js"></script>
    <script src="../node_modules/codemirror/mode/javascript/javascript.js"></script>
    <script src="../node_modules/codemirror/mode/python/python.js"></script>
    <script src="../node_modules/codemirror/mode/clike/clike.js"></script>
    <script src="../node_modules/codemirror/mode/htmlmixed/htmlmixed.js"></script>
    <script src="../node_modules/codemirror/mode/css/css.js"></script>
    <script src="../node_modules/codemirror/mode/xml/xml.js"></script>
    <script src="../node_modules/codemirror/mode/sql/sql.js"></script>
    <script src="editor.js"></script>
<script>

  let currentFilePath = null;
  let recentFiles = [];
  let editor = initCodeMirror("editor");
  let isResizing = false;

  const leftSide = document.querySelector("#left-side");
  const rightSide = document.querySelector("#right-side");
  const resizeHandle = document.querySelector(".resize-handle");
  const title = document.querySelector("#title");
  const createInput = document.querySelector("#create-input");
  const saveIcon = document.querySelector("#save-icon");
  const addIcon = document.querySelector("#add-icon");
  const delIcon = document.querySelector("#del-icon");


  const initUI = async () => {
    const openButton = document.createElement("i");
    openButton.className = "material-icons";
    openButton.textContent = "folder_open";
    openButton.style.cursor = "pointer";
    openButton.style.marginLeft = "10px";
    openButton.onclick = openFile;
    createInput.insertAdjacentElement("afterend", openButton);

    await loadAppState();
    

    addIcon.onclick = createNewFile;
    saveIcon.onclick = saveCurrentFile;
    delIcon.onclick = deleteCurrentFile;
    editor.on("change", () => saveIcon.style.color = "var(--active-color)");

    initResizeHandle();
  };

  const initResizeHandle = () => {
    const initialWidth = localStorage.getItem("sidebarWidth") 
      ? Math.max(150, Math.min(400, parseInt(localStorage.getItem("sidebarWidth"))))
      : 200;
    
    leftSide.style.width = `${initialWidth}px`;
    updateEditorLayout();

    resizeHandle.addEventListener("mousedown", (e) => {
      isResizing = true;
      document.body.style.cursor = "col-resize";
      document.addEventListener("mousemove", handleResize);
      document.addEventListener("mouseup", stopResize);
      e.preventDefault();
    });
  };

  const updateEditorLayout = () => {
    const leftWidth = parseInt(getComputedStyle(leftSide).width);
    rightSide.style.left = `${leftWidth}px`;
    rightSide.style.width = `calc(100% - ${leftWidth}px)`;
    
    if (editor && typeof editor.refresh === 'function') {
      setTimeout(() => editor.refresh(), 10);
    }
  };


  const handleResize = (e) => {
    if (!isResizing) return;
    
    const newWidth = e.clientX;
    const minWidth = 150;
    const maxWidth = 400;

    if (newWidth < minWidth || newWidth > maxWidth) return;

    leftSide.style.width = `${newWidth}px`;
    updateEditorLayout();
  };

  const stopResize = () => {
    if (!isResizing) return;
    isResizing = false;
    document.body.style.cursor = "";
    document.removeEventListener("mousemove", handleResize);
    document.removeEventListener("mouseup", stopResize);
    localStorage.setItem("sidebarWidth", parseInt(leftSide.style.width));
  };

  const loadAppState = async () => {
    try {
      const state = JSON.parse(localStorage.getItem("editorState") || "{}");
      
 
      if (state.recentFiles) {
        recentFiles = state.recentFiles.filter(filePath => {
          try {
            return window.electronAPI.checkFileExists(filePath);
          } catch {
            return false;
          }
        });
        updateRecentFilesList();
      }
      
   
      if (state.lastOpenedFile && await window.electronAPI.checkFileExists(state.lastOpenedFile)) {
        await loadFile(state.lastOpenedFile);
      }
    } catch (e) {
      console.error("Ошибка загрузки состояния:", e);
    }
  };

  const saveAppState = () => {
    const state = {
      lastOpenedFile: currentFilePath,
      recentFiles: recentFiles.slice(0, 10) 
    };
    localStorage.setItem("editorState", JSON.stringify(state));
  };

  const updateRecentFilesList = () => {
    const container = leftSide.querySelector(".recent-files") || document.createElement("div");
    container.className = "recent-files";
    container.innerHTML = recentFiles.map(file => `
      <div class="file-block">
        <i class="material-icons file-icon">${file === currentFilePath ? 'drafts' : 'description'}</i>
        <p class="file-name" title="${file}">${window.electronAPI.getFileName(file)}</p>
      </div>
    `).join("");
    
    if (!leftSide.querySelector(".recent-files")) {
      leftSide.appendChild(container);
    }
    
    
    container.querySelectorAll(".file-block").forEach((el, i) => {
      el.onclick = () => loadFile(recentFiles[i]);
    });
  };


  const openFile = async () => {
    const filePath = await window.electronAPI.openFileDialog();
    if (filePath) {
      await loadFile(filePath);
    }
  };


  const loadFile = async (filePath) => {
    try {
      const content = await window.electronAPI.readFile(filePath);
      editor.setValue(content);
      currentFilePath = filePath;
      title.textContent = window.electronAPI.getFileName(filePath);
      
      
      rightSide.style.display = "flex";
      updateEditorLayout();
      
      setEditorMode(editor, filePath);
      
    
      recentFiles = [
        filePath,
        ...recentFiles.filter(f => f !== filePath)
      ].slice(0, 10);
      
      updateRecentFilesList();
      saveAppState();
    } catch (error) {
      console.error("Ошибка загрузки файла:", error);
    }
  };

  
  const createNewFile = async () => {
    const fileName = createInput.value.trim();
    if (!fileName) return;
    
    const filePath = await window.electronAPI.saveFileDialog(fileName);
    if (filePath) {
      try {
        await window.electronAPI.writeFile(filePath, "");
        createInput.value = "";
        await loadFile(filePath);
      } catch (error) {
        console.error("Ошибка создания файла:", error);
      }
    }
  };


  const saveCurrentFile = async () => {
    if (!currentFilePath) {
      return await saveFileAs();
    }
    
    try {
      await window.electronAPI.writeFile(currentFilePath, editor.getValue());
      saveIcon.style.color = "var(--text-color)";
      saveAppState();
      return true;
    } catch (error) {
      console.error("Ошибка сохранения файла:", error);
      return false;
    }
  };

 
  const saveFileAs = async () => {
    const filePath = await window.electronAPI.saveFileDialog(currentFilePath);
    if (filePath) {
      await window.electronAPI.writeFile(filePath, editor.getValue());
      await loadFile(filePath);
      return true;
    }
    return false;
  };


  const deleteCurrentFile = async () => {
    if (!currentFilePath || !confirm("Удалить текущий файл?")) return;
    
    try {
      await window.electronAPI.deleteFile(currentFilePath);
      editor.setValue("");
      recentFiles = recentFiles.filter(f => f !== currentFilePath);
      currentFilePath = null;
      title.textContent = "";
      rightSide.style.display = "none";
      saveAppState();
      updateRecentFilesList();
    } catch (error) {
      console.error("Ошибка удаления файла:", error);
    }
  };
  window.addEventListener("load", initUI);
  window.addEventListener("beforeunload", saveAppState);
</script>
  </body>
</html>
